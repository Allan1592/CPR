<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rateio - CPP II Bauru</title>
    <link rel="icon" type="image/png" href="icone.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --verde: #2d9344; --laranja: #e67e22; --azul: #3498db; --vermelho: #d32f2f; --cinza-claro: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cinza-claro); margin: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        .container { width: 95%; max-width: 1200px; margin: 20px auto; flex: 1; }
        .header-container { text-align: center; padding: 10px; }
        .logo-placeholder { width: 100px; height: auto; margin-bottom: 5px; border-radius: 10px; }
        .tela { display: none; background: white; border-radius: 8px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .btn-dash { height: 160px; border: none; border-radius: 12px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; font-weight: bold; font-size: 1.2rem; }
        .btn-dash i { font-size: 3rem; margin-bottom: 15px; }
        .btn-dash:hover { transform: translateY(-5px); filter: brightness(1.1); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .resumo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card-resumo { background: #fdfdfd; border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
        .card-resumo small { color: #666; display: block; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; }
        .card-resumo b { font-size: 1.3rem; color: var(--azul); }
        .table-wrapper { width: 100%; max-height: 480px; overflow-y: auto; overflow-x: auto; border: 1px solid #ddd; border-radius: 4px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 10; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .text-center { text-align: center !important; }
        textarea { width: 100%; height: 80px; border: 1px solid #ccc; border-radius: 6px; padding: 12px; font-size: 0.9rem; margin-bottom: 15px; font-family: inherit; resize: vertical; box-sizing: border-box; }
        .btn-std { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        footer { text-align: center; padding: 25px; color: #777; font-size: 0.9rem; margin-top: auto; }
        #modal-edicao { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:8px; width:350px; }
        .modal-content input { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="main-header" class="header-container">
        <img src="icone.png" alt="Logo CPP II Bauru" class="logo-placeholder">
        <h1 style="margin:0; color:#2c3e50;">SISTEMA DE RATEIO</h1>
        <p style="color:#666;">CPP II "Dr. Eduardo de Oliveira Vianna" de Bauru</p>
    </div>

    <div class="container">
        <section id="tela-menu" class="tela active" style="background:none; box-shadow:none; padding:0;">
            <div class="dashboard-grid">
                <button class="btn-dash" style="background:var(--verde)" onclick="navegar('tela-empresas')"><i class="fa fa-building"></i>EMPRESAS</button>
                <button class="btn-dash" style="background:var(--laranja)" onclick="navegar('tela-cadastro')"><i class="fa fa-users"></i>FUNCIONÁRIOS</button>
                <button class="btn-dash" style="background:var(--azul)" onclick="navegar('tela-pagamentos')"><i class="fa fa-file-invoice-dollar"></i>RELATÓRIO</button>
            </div>
        </section>

        <section id="tela-empresas" class="tela">
            <button onclick="navegar('tela-menu')" class="btn-std" style="background:#666;">← Voltar</button>
            <h3 style="color:var(--verde)">Lançamento M.O.I (Receitas)</h3>
            <textarea id="txt-empresas" placeholder="Cole os dados do Excel |Nome e Valor..."></textarea>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                <select id="sel-mes-referencia" style="padding:10px; border-radius:4px;">
                    <option value="">Mês de Referência</option>
                    <option>Janeiro</option><option>Fevereiro</option><option>Março</option><option>Abril</option>
                    <option>Maio</option><option>Junho</option><option>Julho</option><option>Agosto</option>
                    <option>Setembro</option><option>Outubro</option><option>Novembro</option><option>Dezembro</option>
                </select>
                <select id="sel-ano-referencia" style="padding:10px; border-radius:4px;"><option>2025</option><option selected>2026</option></select>
                <button onclick="importar('emp')" class="btn-std" style="background:var(--verde)">Processar Dados</button>
                <button onclick="limparRemoto('limparEmpresas')" class="btn-std" style="background:var(--vermelho)">Limpar Tudo</button>
            </div>
            <div class="table-wrapper">
                <table id="tab-empresas">
                    <thead><tr><th class="text-center">Nº</th><th>Empresa</th><th class="text-center">Valor</th><th class="text-center">Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <p style="text-align: right; font-weight: bold; color: var(--verde); font-size: 1.2rem;">TOTAL M.O.I: <span id="total-emp-display">0,00</span></p>
        </section>

        <section id="tela-cadastro" class="tela">
            <button onclick="navegar('tela-menu')" class="btn-std" style="background:#666;">← Voltar</button>
            <h3 style="color:var(--laranja)">Gestão de Funcionários</h3>
            <textarea id="txt-funcs" placeholder="Cole os dados do Excel: |matrícula|Nome|Dias|Setor"></textarea>
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="importar('func')" class="btn-std" style="background:var(--laranja)">Importar Lista</button>
                <button onclick="limparRemoto('limparFuncionarios')" class="btn-std" style="background:var(--vermelho)">Limpar Todos</button>
            </div>
            <div class="table-wrapper">
                <table id="tab-funcs">
                    <thead><tr><th class="text-center">Matrícula</th><th>Nome</th><th class="text-center">Dias</th><th class="text-center">Setor</th><th class="text-center">Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="tela-pagamentos" class="tela">
            <button onclick="navegar('tela-menu')" class="btn-std" style="background:#666;">← Voltar</button>
            <h3 id="titulo-pagamentos" style="color:var(--azul)">Relatório de Pagamentos</h3>
            <div class="resumo-grid">
                <div class="card-resumo"><small>Total M.O.I</small><b id="esp-total-moi" style="color:var(--verde)">0,00</b></div>
                <div class="card-resumo"><small>Total Dias</small><b id="esp-total-dias">0</b></div>
                <div class="card-resumo"><small>Valor Dia</small><b id="esp-valor-dia" style="color:var(--laranja)">0,00</b></div>
            </div>
            <div style="text-align: right; margin-bottom: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="exportarExcel()" class="btn-std" style="background:#1d6f42;"><i class="fa fa-file-excel"></i> Excel</button>
                <button onclick="exportarPDF()" class="btn-std" style="background:#d32f2f;"><i class="fa fa-file-pdf"></i> PDF</button>
            </div>
            <div class="table-wrapper">
                <table id="tab-rateio">
                    <thead><tr><th class="text-center">Matrícula</th><th>Nome</th><th class="text-center">Setor</th><th class="text-center">Dias</th><th class="text-center">Total Final</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="modal-edicao"><div class="modal-content"><h4 style="margin-top:0">Editar Registro</h4><div id="corpo-modal"></div><div style="margin-top:20px; text-align:right;"><button onclick="salvarEdicao()" class="btn-std" style="background:var(--verde)">Salvar</button> <button onclick="fecharModal()" class="btn-std" style="background:#666">Sair</button></div></div></div>

    <footer>Desenvolvido por: <b>Allan Ramos | Policial Penal do CPP II de Bauru</b></footer>

    <script>
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxfCfWVF-fIn1KLcG1yzuCTzD4tkRwL5fNWR76MFkTVysrRZBo-1AsyMnOuPBE5isia/exec";
        let empresas = [], funcionarios = [], idEditando = null, tipoEditando = '';

        function navegar(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('main-header').style.display = (id === 'tela-menu' ? 'block' : 'none');
            if(id === 'tela-pagamentos') calcular();
        }

        function fmt(valor) {
            return (Math.round(valor * 100) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function importar(tipo) {
            if(tipo === 'emp' && !document.getElementById('sel-mes-referencia').value) return alert("Selecione o Mês!");
            const txt = document.getElementById(tipo === 'emp' ? 'txt-empresas' : 'txt-funcs').value.trim();
            if(!txt) return;

            txt.split('\n').forEach(linha => {
                const c = linha.split('\t');
                if(tipo === 'emp' && c.length >= 2) {
                    const col1 = c[0].toUpperCase().trim();
                    if(!isNaN(col1) || col1.includes("Nº") || col1.includes("EMPRESA") || col1.includes("TOTAL")) return;
                    let v = c[1].replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
                    if(!isNaN(parseFloat(v))) empresas.push({ nome: c[0].trim(), valor: parseFloat(v) });
                } else if(tipo === 'func' && c.length >= 3) {
                    if(c[0].toUpperCase().includes("MATRÍCULA")) return;
                    funcionarios.push({ matricula: c[0].trim(), nome: c[1].trim(), dias: parseFloat(c[2]) || 0, setor: (c[3] || 'Geral').trim() });
                }
            });
            tipo === 'emp' ? (renderEmp(), salvar('salvarEmpresas', empresas)) : (renderFunc(), salvar('salvarTodosFuncionarios', funcionarios));
            document.getElementById(tipo === 'emp' ? 'txt-empresas' : 'txt-funcs').value = '';
        }

        function renderEmp() {
            const tb = document.querySelector('#tab-empresas tbody'); tb.innerHTML = ''; let total = 0;
            empresas.forEach((e, i) => { 
                total += e.valor; 
                tb.innerHTML += `<tr><td class="text-center">${i+1}</td><td>${e.nome}</td><td class="text-center">${fmt(e.valor)}</td><td class="text-center"><button class="btn-icon" onclick="abrirEdicao('emp',${i})" style="color:var(--laranja)"><i class="fa fa-edit"></i></button><button class="btn-icon" onclick="excluir('emp',${i})" style="color:var(--vermelho)"><i class="fa fa-trash"></i></button></td></tr>`; 
            });
            document.getElementById('total-emp-display').innerText = fmt(total);
        }

        function renderFunc() {
            const tb = document.querySelector('#tab-funcs tbody'); tb.innerHTML = '';
            funcionarios.forEach((f, i) => { 
                tb.innerHTML += `<tr><td class="text-center">${f.matricula}</td><td>${f.nome}</td><td class="text-center">${f.dias}</td><td class="text-center">${f.setor}</td><td class="text-center"><button class="btn-icon" onclick="abrirEdicao('func',${i})" style="color:var(--laranja)"><i class="fa fa-edit"></i></button><button class="btn-icon" onclick="excluir('func',${i})" style="color:var(--vermelho)"><i class="fa fa-trash"></i></button></td></tr>`; 
            });
        }

        function calcular() {
            const mes = document.getElementById('sel-mes-referencia').value;
            const ano = document.getElementById('sel-ano-referencia').value;
            document.getElementById('titulo-pagamentos').innerText = `Relatório de Pagamentos - ${mes} / ${ano}`;
            const bruto = empresas.reduce((a, b) => a + b.valor, 0);
            const totalDias = funcionarios.reduce((a, b) => a + b.dias, 0);
            const valorDia = totalDias > 0 ? bruto / totalDias : 0;
            document.getElementById('esp-total-moi').innerText = fmt(bruto);
            document.getElementById('esp-total-dias').innerText = totalDias;
            document.getElementById('esp-valor-dia').innerText = fmt(valorDia);
            const tb = document.querySelector('#tab-rateio tbody'); tb.innerHTML = '';
            funcionarios.forEach(f => {
                const totalFunc = f.dias * valorDia;
                tb.innerHTML += `<tr><td class="text-center">${f.matricula}</td><td>${f.nome}</td><td class="text-center">${f.setor}</td><td class="text-center">${f.dias}</td><td class="text-center"><b>${fmt(totalFunc)}</b></td></tr>`;
            });
        }

        function abrirEdicao(t, i) {
            tipoEditando = t; idEditando = i; const c = document.getElementById('corpo-modal');
            if(t==='emp') c.innerHTML = `Empresa: <input id="ed-1" value="${empresas[i].nome}"> Valor: <input id="ed-2" type="number" step="0.01" value="${empresas[i].valor}">`;
            else c.innerHTML = `Nome: <input id="ed-1" value="${funcionarios[i].nome}"> Dias: <input id="ed-2" type="number" step="0.5" value="${funcionarios[i].dias}"> Setor: <input id="ed-3" value="${funcionarios[i].setor}">`;
            document.getElementById('modal-edicao').style.display = 'flex';
        }

        function salvarEdicao() {
            if(tipoEditando === 'emp') { empresas[idEditando].nome = document.getElementById('ed-1').value; empresas[idEditando].valor = parseFloat(document.getElementById('ed-2').value) || 0; renderEmp(); salvar('salvarEmpresas', empresas); }
            else { funcionarios[idEditando].nome = document.getElementById('ed-1').value; funcionarios[idEditando].dias = parseFloat(document.getElementById('ed-2').value) || 0; funcionarios[idEditando].setor = document.getElementById('ed-3').value; renderFunc(); salvar('salvarTodosFuncionarios', funcionarios); }
            fecharModal();
        }

        function fecharModal() { document.getElementById('modal-edicao').style.display = 'none'; }
        function excluir(t, i) { if(confirm("Excluir?")) { t === 'emp' ? (empresas.splice(i,1), renderEmp(), salvar('salvarEmpresas', empresas)) : (funcionarios.splice(i,1), renderFunc(), salvar('salvarTodosFuncionarios', funcionarios)); } }
        async function salvar(a, d) { fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ acao: a, dados: d }) }); }
        async function carregar() { try { const res = await fetch(URL_SCRIPT); const d = await res.json(); empresas = d.empresas || []; funcionarios = d.funcionarios || []; renderEmp(); renderFunc(); } catch(e) {} }
        async function limparRemoto(a) { if(confirm("Limpar?")) { a === 'limparEmpresas' ? (empresas = [], renderEmp()) : (funcionarios = [], renderFunc()); salvar(a, []); } }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const mes = document.getElementById('sel-mes-referencia').value;
            const ano = document.getElementById('sel-ano-referencia').value;
            const totalMoi = fmt(empresas.reduce((a, b) => a + b.valor, 0));

            doc.setFontSize(11); doc.text("Secretaria da Administração Penitenciária", 148.5, 12, { align: "center" });
            doc.text("CPP II \"Dr. Eduardo de Oliveira Vianna\" de Bauru", 148.5, 22, { align: "center" });
            doc.setFillColor(45, 147, 68); doc.rect(14, 28, 269, 10, 'F');
            doc.setFontSize(12); doc.setTextColor(255, 255, 255);
            doc.text("Relatório de Rateio", 18, 34.5); 
            doc.setFontSize(10); doc.text(`TOTAL M.O.I: ${totalMoi}`, 279, 34.5, { align: "right" });
            doc.setTextColor(0, 0, 0); doc.text(`Referência: ${mes} / ${ano}`, 14, 42);

            const dadosEmpresas = empresas.map((e, idx) => [idx+1, e.nome, fmt(e.valor)]);
            doc.autoTable({ 
                head: [['Nº', 'Empresas', 'Valor']], body: dadosEmpresas, startY: 46, theme: 'grid', styles: { fontSize: 8.5 },
                headStyles: { halign: 'center' }, // Centraliza cabeçalho
                columnStyles: { 0: { halign: 'center' }, 2: { halign: 'center' } } 
            });

            doc.setFont("helvetica", "bold"); doc.text("Relatório de Pagamentos", 14, doc.lastAutoTable.finalY + 10);
            const headRateio = [['Matrícula', 'Nome', 'Setor', 'Dias', 'Total Final']];
            const bodyRateio = Array.from(document.querySelectorAll("#tab-rateio tbody tr")).map(tr => {
                return Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
            });
            doc.autoTable({ 
                head: headRateio, body: bodyRateio, startY: doc.lastAutoTable.finalY + 15, theme: 'grid', styles: { fontSize: 8.5 }, 
                headStyles: { fillColor: [45, 147, 68], halign: 'center' },
                columnStyles: { 0: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center' }, 4: { halign: 'center' } }
            });
            doc.save(`Rateio_${mes}_${ano}.pdf`);
        }

        function exportarExcel() {
            const dataRef = `${document.getElementById('sel-mes-referencia').value}_${document.getElementById('sel-ano-referencia').value}`;
            const ws_data = [ ["Relatório de Rateio - CPP II Bauru"], [], ["Nº", "Empresas", "Valor"] ];
            empresas.forEach((e, i) => ws_data.push([i+1, e.nome, fmt(e.valor)]));
            ws_data.push([""], ["RELATÓRIO DE PAGAMENTOS"], ["Matrícula", "Nome", "Setor", "Dias", "Total Final"]);
            Array.from(document.querySelectorAll("#tab-rateio tbody tr")).forEach(tr => {
                ws_data.push(Array.from(tr.querySelectorAll("td")).map(td => td.innerText));
            });
            const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Rateio"); XLSX.writeFile(wb, `Rateio_${dataRef}.xlsx`);
        }
        window.onload = carregar;
    </script>
</body>
</html>
