<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rateio v2.3 - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --verde: #2d9344; --laranja: #e67e22; --azul: #3498db; --vermelho: #d32f2f;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 10px; }
        .tela { display: none; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .active { display: block; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .btn-dash { height: 150px; border: none; border-radius: 15px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; font-weight: bold; font-size: 1.1rem; }
        .btn-dash:hover { transform: translateY(-5px); opacity: 0.9; }

        /* Tabelas e Inputs */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th { background: #f8f9fa; padding: 10px; border-bottom: 2px solid #ddd; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        textarea { width: 100%; height: 60px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        
        .btn-std { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .resumo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    </style>
</head>
<body>

    <header id="header-main">
        <h1>Sistema de Rateio</h1>
        <p>Controle de Arrecadação e Pagamentos</p>
    </header>

    <div class="container">
        <section id="tela-menu" class="tela active" style="background:none; box-shadow:none;">
            <div class="dashboard-grid">
                <button class="btn-dash" style="background:var(--verde)" onclick="navegar('tela-empresas')"><i class="fa fa-building fa-2x"></i><br>Empresas</button>
                <button class="btn-dash" style="background:var(--laranja)" onclick="navegar('tela-cadastro')"><i class="fa fa-users fa-2x"></i><br>Funcionários</button>
                <button class="btn-dash" style="background:var(--azul)" onclick="navegar('tela-pagamentos')"><i class="fa fa-file-invoice-dollar fa-2x"></i><br>Relatório Final</button>
            </div>
        </section>

        <section id="tela-empresas" class="tela">
            <button onclick="navegar('tela-menu')">← Voltar</button>
            <h3>Gerenciar Empresas</h3>
            <textarea id="txt-empresas" placeholder="Cole do Excel: Empresa [TAB] Valor"></textarea>
            <div style="margin-bottom:15px;">
                <button onclick="importar('emp')" class="btn-std" style="background:var(--verde)">Importar Dados</button>
                <button onclick="limparRemoto('limparEmpresas')" class="btn-std" style="background:var(--vermelho); margin-left:10px;">Limpar Planilha</button>
            </div>
            <table id="tab-empresas">
                <thead><tr><th>Empresa</th><th>Valor</th><th>Ações</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><td align="right"><b>TOTAL:</b></td><td id="total-emp" style="font-weight:bold; color:green;">R$ 0,00</td><td></td></tr></tfoot>
            </table>
        </section>

        <section id="tela-cadastro" class="tela">
            <button onclick="navegar('tela-menu')">← Voltar</button>
            <h3>Gerenciar Funcionários</h3>
            <textarea id="txt-funcs" placeholder="Matrícula [TAB] Nome [TAB] Dias [TAB] Setor [TAB] Bônus"></textarea>
            <div style="margin-bottom:15px;">
                <button onclick="importar('func')" class="btn-std" style="background:var(--verde)">Importar Dados</button>
                <button onclick="limparRemoto('limparFuncionarios')" class="btn-std" style="background:var(--vermelho); margin-left:10px;">Limpar Planilha</button>
            </div>
            <table id="tab-funcs">
                <thead><tr><th>Matrícula</th><th>Nome</th><th>Dias</th><th>Setor</th><th>Bônus</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="tela-pagamentos" class="tela">
            <button onclick="navegar('tela-menu')">← Voltar</button>
            <h3>Relatório de Rateio - Fevereiro/2026</h3>
            <div class="resumo-grid">
                <div class="card">Funcionários<br><b id="res-qtd">0</b></div>
                <div class="card">Total de Dias<br><b id="res-dias">0</b></div>
                <div class="card">Valor do Dia<br><b id="res-vdia">R$ 0,00</b></div>
            </div>
            <div style="text-align:right; margin-bottom:10px;">
                <button onclick="exportarExcel()" class="btn-std" style="background:#1d6f42;">Excel</button>
                <button onclick="exportarPDF()" class="btn-std" style="background:#d32f2f;">PDF</button>
            </div>
            <table id="tab-rateio">
                <thead><tr><th>Matrícula</th><th>Nome</th><th>Setor</th><th>Dias</th><th>Bônus</th><th>Total a Receber</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <script>
        // COLE O SEU URL DO GOOGLE AQUI:
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzD7tsKOasJUNiXPlHaP3Sv9CXAKibAFNvhCiVgqyiaTjRj0m-ko1MFNkDr9qfq0PZE/exec";
        
        let empresas = [], funcionarios = [];

        function navegar(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('header-main').style.display = (id === 'tela-menu' ? 'block' : 'none');
            if(id === 'tela-pagamentos') calcular();
        }

        function importar(tipo) {
            const txt = document.getElementById(tipo === 'emp' ? 'txt-empresas' : 'txt-funcs').value.trim();
            if(!txt) return alert("Cole os dados primeiro!");
            
            txt.split('\n').forEach(linha => {
                const c = linha.split('\t');
                if(tipo === 'emp' && c.length >= 2) {
                    let v = c[1].replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
                    empresas.push({ nome: c[0].trim(), valor: parseFloat(v) || 0 });
                } else if(tipo === 'func' && c.length >= 4) {
                    funcionarios.push({
                        matricula: c[0].trim(), nome: c[1].trim(),
                        dias: parseFloat(c[2]) || 0, setor: c[3].trim(),
                        bonus: (c[4] && c[4].toLowerCase().includes('sim')) ? 'Sim' : 'Não'
                    });
                }
            });
            
            if(tipo === 'emp') { renderEmp(); salvar('salvarEmpresas', empresas); }
            else { renderFunc(); salvar('salvarTodosFuncionarios', funcionarios); }
            document.getElementById(tipo === 'emp' ? 'txt-empresas' : 'txt-funcs').value = '';
        }

        function renderEmp() {
            const tb = document.querySelector('#tab-empresas tbody');
            tb.innerHTML = ''; let total = 0;
            empresas.forEach((e, i) => {
                total += e.valor;
                tb.innerHTML += `<tr><td>${e.nome}</td><td>R$ ${e.valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                <td><button onclick="excluir('emp',${i})" style="color:red; border:none; background:none; cursor:pointer;">Excluir</button></td></tr>`;
            });
            document.getElementById('total-emp').innerText = "R$ " + total.toLocaleString('pt-BR',{minimumFractionDigits:2});
        }

        function renderFunc() {
            const tb = document.querySelector('#tab-funcs tbody');
            tb.innerHTML = '';
            funcionarios.forEach((f, i) => {
                tb.innerHTML += `<tr><td>${f.matricula}</td><td>${f.nome}</td><td>${f.dias}</td><td>${f.setor}</td><td>${f.bonus}</td>
                <td><button onclick="excluir('func',${i})" style="color:red; border:none; background:none; cursor:pointer;">Excluir</button></td></tr>`;
            });
        }

        function calcular() {
            const arrecadado = empresas.reduce((a, b) => a + b.valor, 0);
            const totalDias = funcionarios.reduce((a, b) => a + b.dias, 0);
            const qtdBonus = funcionarios.filter(f => f.bonus === 'Sim').length;
            
            const valorDia = totalDias > 0 ? (arrecadado - (qtdBonus * 200)) / totalDias : 0;
            
            document.getElementById('res-qtd').innerText = funcionarios.length;
            document.getElementById('res-dias').innerText = totalDias;
            document.getElementById('res-vdia').innerText = "R$ " + valorDia.toLocaleString('pt-BR',{minimumFractionDigits:4});

            const tb = document.querySelector('#tab-rateio tbody');
            tb.innerHTML = '';
            funcionarios.forEach(f => {
                const total = (f.dias * valorDia) + (f.bonus === 'Sim' ? 200 : 0);
                tb.innerHTML += `<tr><td>${f.matricula}</td><td>${f.nome}</td><td>${f.setor}</td><td>${f.dias}</td><td>${f.bonus === 'Sim' ? 'R$ 200' : '-'}</td><td><b>R$ ${total.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b></td></tr>`;
            });
        }

        async function limparRemoto(acao) {
            if(!confirm("Isso apagará permanentemente os dados da planilha. Confirma?")) return;
            if(acao === 'limparEmpresas') { empresas = []; renderEmp(); } else { funcionarios = []; renderFunc(); }
            await salvar(acao, []);
            alert("Planilha limpa!");
        }

        function excluir(tipo, i) {
            if(tipo === 'emp') { empresas.splice(i,1); renderEmp(); salvar('salvarEmpresas', empresas); }
            else { funcionarios.splice(i,1); renderFunc(); salvar('salvarTodosFuncionarios', funcionarios); }
        }

        async function salvar(acao, dados) {
            fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ acao, dados }) });
        }

        async function carregar() {
            try {
                const res = await fetch(URL_SCRIPT);
                const d = await res.json();
                empresas = d.empresas || [];
                funcionarios = d.funcionarios || [];
                renderEmp(); renderFunc();
            } catch(e) { console.log("Iniciando com dados vazios"); }
        }

        function exportarExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('tab-rateio')), "Rateio.xlsx"); }
        function exportarPDF() { 
            const doc = new jspdf.jsPDF(); 
            doc.text("Relatório de Rateio", 14, 15);
            doc.autoTable({ html: '#tab-rateio', startY: 20 });
            doc.save("Rateio.pdf");
        }

        window.onload = carregar;
    </script>
</body>
</html>
