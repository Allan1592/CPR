<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rateio - CPP II Bauru</title>
    
    <link rel="icon" type="image/png" href="URL_DA_SUA_IMAGEM_AQUI">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --verde: #2d9344; --laranja: #e67e22; --azul: #3498db; --vermelho: #d32f2f; --cinza: #f4f7f6; }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--cinza); margin: 0; color: #333; transition: 0.5s; }
        
        /* Estilos de Fundo Dinâmicos */
        .bg-menu { background: var(--cinza); }
        .bg-empresas { background: var(--verde); }
        .bg-cadastro { background: var(--laranja); }
        .bg-pagamentos { background: var(--azul); }

        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* Logo e Título */
        .header-container { text-align: center; padding: 20px; }
        .logo-placeholder { width: 100px; height: auto; margin-bottom: 10px; }
        
        .tela { display: none; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-top: 20px; }
        .active { display: block; }

        /* Dashboard Menu */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 30px; }
        .btn-dash { height: 180px; border: none; border-radius: 20px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; font-weight: bold; font-size: 1.3rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-dash i { font-size: 3rem; margin-bottom: 15px; }
        .btn-dash:hover { transform: translateY(-8px); box-shadow: 0 12px 20px rgba(0,0,0,0.2); }

        /* Card de Orientações */
        .card-info { background: #fff; border-left: 5px solid var(--azul); padding: 20px; border-radius: 10px; margin-top: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-info h4 { margin-top: 0; color: var(--azul); display: flex; align-items: center; }
        .card-info ul { padding-left: 20px; font-size: 0.95rem; line-height: 1.6; }

        /* Tabelas e Inputs */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #ddd; }
        .text-center { text-align: center !important; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        textarea { width: 100%; height: 80px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        .btn-std { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn-std:hover { opacity: 0.8; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        
        .sel-mes { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; margin-right: 10px; }
    </style>
</head>
<body class="bg-menu">

    <div class="header-container">
        <img src="https://via.placeholder.com/150x80?text=LOGO+SAP" alt="Logo SAP" class="logo-placeholder">
        <h1 style="margin:0; color:#2c3e50;">Sistema de Rateio</h1>
        <p style="color:#666;">CPP II "Dr. Eduardo de Oliveira Vianna" de Bauru</p>
    </div>

    <div class="container">
        <section id="tela-menu" class="tela active" style="background:none; box-shadow:none; padding:0;">
            <div class="dashboard-grid">
                <button class="btn-dash" style="background:var(--verde)" onclick="navegar('tela-empresas')">
                    <i class="fa fa-building"></i>GESTÃO DE EMPRESAS
                </button>
                <button class="btn-dash" style="background:var(--laranja)" onclick="navegar('tela-cadastro')">
                    <i class="fa fa-users"></i>GESTÃO DE FUNCIONÁRIOS
                </button>
                <button class="btn-dash" style="background:var(--azul)" onclick="navegar('tela-pagamentos')">
                    <i class="fa fa-file-invoice-dollar"></i>RELATÓRIO FINAL
                </button>
            </div>

            <div class="card-info">
                <h4><i class="fa fa-info-circle" style="margin-right:10px;"></i> ORIENTAÇÕES DE PREENCHIMENTO</h4>
                <ul>
                    <li><b>1º Passo:</b> Acesse "Gestão de Empresas", selecione o <b>Mês/Ano</b> e cole os dados (Empresa [TAB] Valor).</li>
                    <li><b>2º Passo:</b> No menu "Gestão de Funcionários", importe a lista de quem trabalhou (Matrícula [TAB] Nome [TAB] Dias...).</li>
                    <li><b>3º Passo:</b> Use o botão "Editar" (ícone lápis) para ajustar bônus ou faltas caso necessário.</li>
                    <li><b>4º Passo:</b> Vá em "Relatório Final" para conferir os cálculos e exportar o PDF oficial assinado.</li>
                </ul>
            </div>
        </section>

        <section id="tela-empresas" class="tela">
            <button onclick="navegar('tela-menu')" class="btn-std" style="background:#666; margin-bottom:20px;">← Voltar ao Menu</button>
            <h2 style="color:var(--verde)">Lançamento M.O.I (Receitas)</h2>
            <textarea id="txt-empresas" placeholder="Dica: Copie do Excel e cole aqui (Empresa e Valor)"></textarea>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <select id="sel-mes-referencia" class="sel-mes">
                    <option value="">Selecione o Mês</option>
                    <option>Janeiro</option><option>Fevereiro</option><option>Março</option><option>Abril</option>
                    <option>Maio</option><option>Junho</option><option>Julho</option><option>Agosto</option>
                    <option>Setembro</option><option>Outubro</option><option>Novembro</option><option>Dezembro</option>
                </select>
                <select id="sel-ano-referencia" class="sel-mes">
                    <option>2025</option><option selected>2026</option><option>2027</option>
                </select>
                <button onclick="importar('emp')" class="btn-std" style="background:var(--verde)">PROCESSAR DADOS</button>
                <button onclick="limparRemoto('limparEmpresas')" class="btn-std" style="background:var(--vermelho)">LIMPAR TUDO</button>
            </div>
            <table id="tab-empresas">
                <thead><tr><th class="text-center">Nº</th><th>Empresa</th><th class="text-center">Valor</th><th class="text-center">Ações</th></tr></thead>
                <tbody></tbody>
                <tfoot><tr><td colspan="2" align="right"><b>TOTAL M.O.I:</b></td><td id="total-emp" class="text-center" style="font-weight:bold; color:green;">R$ 0,00</td><td></td></tr></tfoot>
            </table>
        </section>

        <section id="tela-cadastro" class="tela">
            <button onclick="navegar('tela-menu')" class="btn-std" style="background:#666; margin-bottom:20px;">← Voltar ao Menu</button>
            <h2 style="color:var(--laranja)">Cadastro de Funcionários</h2>
            <textarea id="txt-funcs" placeholder="Matrícula [TAB] Nome [TAB] Dias [TAB] Setor [TAB] Bônus"></textarea>
            <div style="margin-bottom:20px;">
                <button onclick="importar('func')" class="btn-std" style="background:var(--laranja)">IMPORTAR LISTA</button>
                <button onclick="limparRemoto('limparFuncionarios')" class="btn-std" style="background:var(--vermelho); margin-left:10px;">LIMPAR TUDO</button>
            </div>
            <table id="tab-funcs">
                <thead><tr><th class="text-center">Matrícula</th><th>Nome</th><th class="text-center">Dias</th><th class="text-center">Setor</th><th class="text-center">Bônus</th><th class="text-center">Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="tela-pagamentos" class="tela">
            <button onclick="navegar('tela-menu')" class="btn-std" style="background:#666; margin-bottom:20px;">← Voltar ao Menu</button>
            <h2 style="color:var(--azul)">Relatório de Rateio Final</h2>
            <div style="text-align:right; margin-bottom:20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="exportarExcel()" class="btn-std" style="background:#1d6f42;"><i class="fa fa-file-excel"></i> Excel</button>
                <button onclick="exportarPDF()" class="btn-std" style="background:#d32f2f;"><i class="fa fa-file-pdf"></i> Gerar PDF Oficial</button>
            </div>
            <table id="tab-rateio">
                <thead><tr><th class="text-center">Matrícula</th><th>Nome</th><th class="text-center">Setor</th><th class="text-center">Dias</th><th class="text-center">Bônus</th><th class="text-center">Total Final</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <div id="modal-edicao">
        <div class="modal-content">
            <h3 id="titulo-modal">Editar Informações</h3>
            <div id="corpo-modal"></div>
            <div style="margin-top:20px; text-align:right;">
                <button onclick="salvarEdicao()" class="btn-std" style="background:var(--verde)">SALVAR</button>
                <button onclick="fecharModal()" class="btn-std" style="background:#666; margin-left:5px;">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- TODA A LÓGICA DE CÁLCULO E EXPORTAÇÃO (CÓDIGO 3) PERMANECE AQUI ---
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxqVP6O_ekunENu_IF5hQivjHlgit00ATawdDSF9A_d1JdgRdixf0LyxRViyz7xPmIQ/exec";
        let empresas = [], funcionarios = [], idEditando = null, tipoEditando = '';

        function navegar(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Troca o fundo do Body conforme a tela
            document.body.className = '';
            if(id === 'tela-menu') document.body.classList.add('bg-menu');
            if(id === 'tela-empresas') document.body.classList.add('bg-empresas');
            if(id === 'tela-cadastro') document.body.classList.add('bg-cadastro');
            if(id === 'tela-pagamentos') { document.body.classList.add('bg-pagamentos'); calcular(); }
        }

        // ... [Manter funções importar, renderEmp, renderFunc, calcular, abrirEdicao, salvarEdicao, excluir, carregar, salvar de acordo com o Código 3 anterior] ...
        
        // Re-incluindo as funções essenciais para o funcionamento completo:
        function importar(tipo) {
            if(tipo === 'emp' && !document.getElementById('sel-mes-referencia').value) return alert("Selecione o Mês!");
            const txt = document.getElementById(tipo === 'emp' ? 'txt-empresas' : 'txt-funcs').value.trim();
            if(!txt) return;
            txt.split('\n').forEach(linha => {
                const c = linha.split('\t');
                if(tipo === 'emp' && c.length >= 2) {
                    let v = c[1].replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
                    empresas.push({ nome: c[0].trim(), valor: parseFloat(v) || 0 });
                } else if(tipo === 'func' && c.length >= 4) {
                    funcionarios.push({ matricula: c[0].trim(), nome: c[1].trim(), dias: parseFloat(c[2]) || 0, setor: c[3].trim(), bonus: (c[4] && c[4].toLowerCase().includes('sim')) ? 'Sim' : 'Não' });
                }
            });
            tipo === 'emp' ? (renderEmp(), salvar('salvarEmpresas', empresas)) : (renderFunc(), salvar('salvarTodosFuncionarios', funcionarios));
            document.getElementById(tipo === 'emp' ? 'txt-empresas' : 'txt-funcs').value = '';
        }

        function renderEmp() {
            const tb = document.querySelector('#tab-empresas tbody'); tb.innerHTML = ''; let total = 0;
            empresas.forEach((e, i) => {
                total += e.valor;
                tb.innerHTML += `<tr><td class="text-center">${i+1}</td><td>${e.nome}</td><td class="text-center">R$ ${e.valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
                <td class="text-center">
                    <button class="btn-icon" onclick="abrirEdicao('emp',${i})" style="color:var(--laranja)"><i class="fa fa-edit"></i></button>
                    <button class="btn-icon" onclick="excluir('emp',${i})" style="color:var(--vermelho)"><i class="fa fa-trash"></i></button>
                </td></tr>`;
            });
            document.getElementById('total-emp').innerText = "R$ " + total.toLocaleString('pt-BR',{minimumFractionDigits:2});
        }

        function renderFunc() {
            const tb = document.querySelector('#tab-funcs tbody'); tb.innerHTML = '';
            funcionarios.forEach((f, i) => {
                tb.innerHTML += `<tr><td class="text-center">${f.matricula}</td><td>${f.nome}</td><td class="text-center">${f.dias}</td><td class="text-center">${f.setor}</td><td class="text-center">${f.bonus}</td>
                <td class="text-center">
                    <button class="btn-icon" onclick="abrirEdicao('func',${i})" style="color:var(--laranja)"><i class="fa fa-edit"></i></button>
                    <button class="btn-icon" onclick="excluir('func',${i})" style="color:var(--vermelho)"><i class="fa fa-trash"></i></button>
                </td></tr>`;
            });
        }

        function calcular() {
            const bruto = empresas.reduce((a, b) => a + b.valor, 0);
            const totalDias = funcionarios.reduce((a, b) => a + b.dias, 0);
            const qtdBonus = funcionarios.filter(f => f.bonus === 'Sim').length;
            const valorDia = totalDias > 0 ? (bruto - (qtdBonus * 200)) / totalDias : 0;
            const tb = document.querySelector('#tab-rateio tbody'); tb.innerHTML = '';
            funcionarios.forEach(f => {
                const total = (f.dias * valorDia) + (f.bonus === 'Sim' ? 200 : 0);
                tb.innerHTML += `<tr><td class="text-center">${f.matricula}</td><td>${f.nome}</td><td class="text-center">${f.setor}</td><td class="text-center">${f.dias}</td><td class="text-center">${f.bonus === 'Sim' ? 'R$ 200' : '-'}</td><td class="text-center"><b>R$ ${total.toLocaleString('pt-BR',{minimumFractionDigits:2})}</b></td></tr>`;
            });
        }

        function abrirEdicao(tipo, i) {
            tipoEditando = tipo; idEditando = i;
            const corpo = document.getElementById('corpo-modal');
            if(tipo === 'emp') {
                corpo.innerHTML = `Nome: <input id="ed-1" value="${empresas[i].nome}"> Valor: <input id="ed-2" type="number" value="${empresas[i].valor}">`;
            } else {
                corpo.innerHTML = `Nome: <input id="ed-1" value="${funcionarios[i].nome}"> Dias: <input id="ed-2" type="number" value="${funcionarios[i].dias}"> Setor: <input id="ed-3" value="${funcionarios[i].setor}"> Bônus: <select id="ed-4"><option ${funcionarios[i].bonus==='Sim'?'selected':''}>Sim</option><option ${funcionarios[i].bonus==='Não'?'selected':''}>Não</option></select>`;
            }
            document.getElementById('modal-edicao').style.display = 'flex';
        }

        function salvarEdicao() {
            if(tipoEditando === 'emp') {
                empresas[idEditando].nome = document.getElementById('ed-1').value;
                empresas[idEditando].valor = parseFloat(document.getElementById('ed-2').value) || 0;
                renderEmp(); salvar('salvarEmpresas', empresas);
            } else {
                funcionarios[idEditando].nome = document.getElementById('ed-1').value;
                funcionarios[idEditando].dias = parseFloat(document.getElementById('ed-2').value) || 0;
                funcionarios[idEditando].setor = document.getElementById('ed-3').value;
                funcionarios[idEditando].bonus = document.getElementById('ed-4').value;
                renderFunc(); salvar('salvarTodosFuncionarios', funcionarios);
            }
            fecharModal();
        }

        function fecharModal() { document.getElementById('modal-edicao').style.display = 'none'; }
        function excluir(tipo, i) { if(confirm("Deseja excluir?")) { tipo === 'emp' ? (empresas.splice(i,1), renderEmp(), salvar('salvarEmpresas', empresas)) : (funcionarios.splice(i,1), renderFunc(), salvar('salvarTodosFuncionarios', funcionarios)); } }
        async function salvar(acao, dados) { fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ acao, dados }) }); }
        async function carregar() { try { const res = await fetch(URL_SCRIPT); const d = await res.json(); empresas = d.empresas || []; funcionarios = d.funcionarios || []; renderEmp(); renderFunc(); } catch(e) { } }
        async function limparRemoto(acao) { if(confirm("Apagar TUDO?")) { acao === 'limparEmpresas' ? (empresas = [], renderEmp()) : (funcionarios = [], renderFunc()); salvar(acao, []); } }

        // --- EXPORTAÇÕES PDF/EXCEL (CÓDIGO 3) ---
        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const dataRef = `${document.getElementById('sel-mes-referencia').value} / ${document.getElementById('sel-ano-referencia').value}`;
            doc.setFontSize(11);
            doc.text("Secretaria da Administração Penitenciária", 148.5, 12, { align: "center" });
            doc.text("Coordenadoria de Execução Penal da Região Noroeste do Estado", 148.5, 17, { align: "center" });
            doc.text("CPP II \"Dr. Eduardo de Oliveira Vianna\" de Bauru", 148.5, 22, { align: "center" });
            doc.setFillColor(45, 147, 68); doc.rect(14, 28, 269, 10, 'F');
            doc.setFontSize(12); doc.setTextColor(255, 255, 255);
            doc.text("Relatório de Rateio", 18, 34.5); doc.text(dataRef, 279, 34.5, { align: "right" });
            doc.setTextColor(0, 0, 0);
            const dadosEmpresas = empresas.map((e, idx) => [idx+1, e.nome, `R$ ${e.valor.toLocaleString('pt-BR',{minimumFractionDigits:2})}`]);
            dadosEmpresas.push(['', {content: 'TOTAL M.O.I', styles: {fontStyle: 'bold', halign: 'right'}}, {content: `R$ ${empresas.reduce((a,b)=>a+b.valor,0).toLocaleString('pt-BR',{minimumFractionDigits:2})}`, styles: {fontStyle: 'bold', halign: 'center'}}]);
            doc.autoTable({ head: [['Nº', 'Empresas', 'Valor']], body: dadosEmpresas, startY: 42, theme: 'grid', styles: { fontSize: 8.5 }, headStyles: { fillColor: [100, 100, 100], halign: 'center' }, columnStyles: { 0:{halign:'center', cellWidth:15}, 2:{halign:'center', cellWidth:45} } });
            doc.autoTable({ html: '#tab-rateio', startY: doc.lastAutoTable.finalY + 12, theme: 'grid', headStyles: { fillColor: [45, 147, 68], halign: 'center' }, styles: { fontSize: 8.5 }, columnStyles: { 0:{halign:'center'}, 2:{halign:'center'}, 3:{halign:'center'}, 4:{halign:'center'}, 5:{halign:'center'} } });
            let finalY = doc.lastAutoTable.finalY + 20; if (finalY > 165) { doc.addPage(); finalY = 30; }
            doc.text("__________________________________________", 148.5, finalY, { align: "center" });
            doc.text("CARLOS HENRIQUE GREJO", 148.5, finalY + 5, { align: "center" });
            doc.text("Chefe de Serviço de Formação Educacional, Trabalho e Capacitação Profissional", 148.5, finalY + 10, { align: "center" });
            doc.text("__________________________________________", 148.5, finalY + 30, { align: "center" });
            doc.text("FLÁVIO ANDRÉ FERREIRA OJAS", 148.5, finalY + 35, { align: "center" });
            doc.text("Chefe de Departamento", 148.5, finalY + 40, { align: "center" });
            doc.save(`Rateio_${dataRef.replace(' / ','_')}.pdf`);
        }

        function exportarExcel() {
            const dataRef = `${document.getElementById('sel-mes-referencia').value} / ${document.getElementById('sel-ano-referencia').value}`;
            const ws_data = [ ["Secretaria da Administração Penitenciária"], ["Coordenadoria de Execução Penal da Região Noroeste do Estado"], ["CPP II \"Dr. Eduardo de Oliveira Vianna\" de Bauru"], ["Relatório de Rateio", "", "", "", "", dataRef], [""], ["Nº", "Empresas", "Valor"] ];
            empresas.forEach((e, i) => ws_data.push([i+1, e.nome, e.valor]));
            ws_data.push(["", "TOTAL M.O.I", empresas.reduce((a,b)=>a+b.valor,0)]);
            ws_data.push([""], ["RELAÇÃO DE PAGAMENTOS"]);
            document.querySelectorAll("#tab-rateio tr").forEach(row => { const rowData = []; row.querySelectorAll("th, td").forEach(cell => rowData.push(cell.innerText)); ws_data.push(rowData); });
            XLSX.writeFile({SheetNames:["Rateio"], Sheets:{Rateio:XLSX.utils.aoa_to_sheet(ws_data)}}, `Rateio_${dataRef.replace(' / ','_')}.xlsx`);
        }
        window.onload = carregar;
    </script>
</body>
</html>
